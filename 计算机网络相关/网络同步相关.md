**网络同步机制**

网络同步的目标就是时刻**保证多台机器的游戏表现完全一致**。

网络同步 = 实时的多端**数据同步**+实时的**多端表现**

同步战斗逻辑是包括技能逻辑、普攻、属性、伤害、移动、AI、检测、碰撞等等的一系列内容，这常常也被视为游戏开发过程中最难的部分。

网络同步按大类来分有两种做法：**状态同步和帧同步**。需要强调的是这两个概念并不是简单的对立概念，其中的差异包括："数据格式与内容"、“逻辑的计算位置”和“是否有权威服务器”等。



## 帧同步LockStep

LockStep的翻译是锁步同步，是齐步行军的意思

基本原理

帧同步的战斗逻辑在客户端 在帧同步下，通信就比较简单了，服务端只**转发操作**，不做任何逻辑处理。 客户端按照**一定的帧速率**（理解为逻辑帧，而不是客户端的渲染帧）去**上传当前的操作指令**，服务端将操作指令**广播给所有客户端**，当客户端收到指令后执行本地代码，如果输入的指令一致，计算的过程一致，那么计算的结果肯定是一致的，这样就能保证所有客户端的同步，这就是帧同步。

**服务器对客户端指令进行收集和转发**



帧同步缺陷

由于帧同步战斗逻辑都在客户端，服务器没有验证，带来的问题就是外挂的产生（加速、透视、自动瞄准、数据修改等） 网络条件较差的客户端会影响其他玩家的游戏体验。（优化方案：乐观帧锁定、渲染与逻辑帧分离、客户端预执行、指令流水线化、操作回滚等） 不同机器浮点数精度问题、容器排序不确定性、RPC时序、随机数值计算不统一



优化方案

乐观帧锁定 ：针对传统严格帧锁定算法中网速慢会卡到网速快的问题，实践中线上动作游戏通常用“定时不等待”的乐观方式再**每次Interval时钟发生时固定将操作广播**给所有用户，不依赖具体每个玩家是否有操作更新：

单个用户当前键盘上下左右攻击跳跃**是否按下用一个32位整数**描述，比如服务端描述一局游戏中最多8玩家的键盘操作为：int player_keyboards[8]; 服务端每秒钟20-50次向所有客户端发送更新消息（包含所有**客户端的操作**和**递增的帧号**）： update=（FrameID，player_keyboards） 客户端就像**播放游戏录像**一样不停的播放这些**包含每帧所有玩家操作的 update消息**。 客户端如果没有update数据了，就必须等待，直到有新的数据到来。 客户端如果一下子收到**很多连续的update**，则**快进播放**。 客户端**只要**按键按下或者放开，就会**发送**消息给服务端（而不是到每帧开始才采集键盘），消息**只包含一个整数**。服务端收到以后，**改写**对应的player_keyboards



## 状态同步

状态同步顾名思义就是**同步各个客户端的状态**，保证每一次操作后的状态是一致的 通过开发服务端程序，把用户的操作作为输入实时上传到服务端，**服务端通过计算返回结果给各个客户端**，这样的过程就是状态同步。



基本原理

状态同步的战斗逻辑在服务端 在状态同步下，客户端更像是一个**服务端数据的表现层** 一般的流程是 客户端**上传操作**到服务器， 服务器收到后**计算游戏行为**的结果，然后以广播的方式下发游戏中各种状态， 客户端收到状态后再根据状态显示内容。



使用场景

目前状态同步多用于CS架构（服务器-客户机），客户端通过RPC（当一个系统被设计为由多个分布式组件组成时，这些组件可能运行在不同的机器上。RPC允许这些组件通过调用远程方法来进行通信，以实现状态同步或共享信息）向服务器发送**指令信息**，服务器通过**属性同步**（是一种在分**布式系统**中用于将对象的状态信息从服务器传输到客户端的方式。与全量状态同步相比，属性同步**仅传输已更改的部分**，从而减少了数据传输的量，提高了效率）向客户端**发送各个对象的状态信息**。我们可以才有预测回滚（预测回滚是一种技术，用于在接收到服务器的更新后，检测到本地预测错误时，将**客户端状态回滚到服务器状态**，然后**重新应用**用户输入。这样，可以通过更准确的服务器状态来纠正客户端预测的错误）、延迟补偿（当客户端接收到其他玩家的状态更新时，它可以通过**根据延迟时间来预测**对方在本地的状态，并相应地调整显示。这样可以减少在显示其他玩家时的感知延迟）、插值（当客户端接收到服务器状态更新时，它可以使用插值算法，如线性插值，**来平滑地过渡到新的状态**。这使得在两个连续的状态之间有一个平滑的过渡，避免了突然的、不自然的变化）等优化方式



状态同步缺陷

状态同步做回放系统的话会是个灾难。 延迟过大、**客户端性能浪费**、**服务端压力大** 对带宽的浪费。对于对象少的游戏，可以用快照保存整个游戏的状态发送，但一旦数量多起来，数量的占用就会直线上升。（优化：增量快照同步，协议同步指定数据）